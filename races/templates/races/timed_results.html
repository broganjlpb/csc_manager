{% extends "base.html" %}
{% load race_extras %}
{% block content %}

<h3>Timed Results â€“ {{ race }}</h3>

<!-- Attempt selector -->
{% if state.total_attempts > 1 %}
<div class="mb-3">
    <strong>Attempts:</strong>
    {% for i in attempt_numbers %}
        <a href="?attempt={{ i }}"
           class="btn btn-sm {% if i == state.attempt %}btn-primary{% else %}btn-outline-primary{% endif %}">
            Attempt {{ i }}
        </a>
    {% endfor %}
</div>
{% endif %}


{% if preview %}

    <table class="table table-sm table-striped align-middle">
        <thead>
            <tr>
                <th>Pos</th>
                <th>Boat</th>
                <th>Helm</th>
                <th>Laps</th>
                <th>Elapsed</th>
                <th>Corrected</th>
                <!-- <th>Points</th> -->
            </tr>
        </thead>
        <tbody>
            {% for row in preview %}
            <tr>
                <td><strong>{{ row.position }}</strong></td>
                <td>{{ row.sail }}</td>
                <td>{{ row.helm }}</td>
                <td>{{ row.laps }}</td>
                <td>{{ row.elapsed|format_time }}</td>
                <td>{{ row.corrected|format_time }}</td>
                <!-- <td>{{ row.points }}</td> -->
                
            </tr>
            {% endfor %}
        </tbody>
    </table>

    
    <form method="post" id="timed-form" class="mt-3">
        {% csrf_token %}
        
        {% if result_set %}
            <button type="button"
                    class="btn btn-warning"
                    id="overwrite-btn">
                Overwrite Existing Timed Result
            </button>
        {% else %}
            <button type="submit"
                    class="btn btn-success">
                Build Timed Result Set
            </button>
        {% endif %}
    </form>

    <!-- Overwrite Confirmation Modal -->
    <div class="modal fade" id="overwriteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Overwrite Existing Result?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                A timed result set already exists.
                <br><br>
                Overwriting will permanently replace your previous result.
            </div>

            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal">
                    Cancel
                </button>

                <button type="button"
                        class="btn btn-danger"
                        id="confirm-overwrite">
                    Yes, Overwrite
                </button>
            </div>

            </div>
        </div>
    </div>


{% else %}

    <div class="alert alert-warning mt-3">
        No valid laps recorded for this attempt.
    </div>

{% endif %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function(){

    const overwriteBtn = document.getElementById("overwrite-btn");

    if(overwriteBtn){

        const modal = new bootstrap.Modal(
            document.getElementById("overwriteModal")
        );

        overwriteBtn.addEventListener("click", function(){
            modal.show();
        });

        document.getElementById("confirm-overwrite")
            .addEventListener("click", function(){
                document.getElementById("timed-form").submit();
            });
    }

});
</script>
{% endblock %}
