{% extends "base.html" %}

{% block content %}

<div data-editing="{% if race.status != race.RaceStatus.FINISHED %}1{% else %}0{% endif %}">

<h3 class="mb-3">Manual Results – {{ race }}</h3>

<form method="post" id="results-form">
    {% csrf_token %}

    <ul id="finish-order" class="list-group mb-3">
        {% for e in entries %}
        <li class="list-group-item d-flex justify-content-between align-items-center
            {% if e.result_status == "dnf" %} list-group-item-warning
            {% elif e.result_status == "dsq" %} list-group-item-danger
            {% endif %}"
            data-id="{{ e.id }}">

            <div>
                <strong class="pos-number">{{ forloop.counter }}.</strong>
                {{ e.boat }} – {{ e.helm.username }}
                {% if e.crew %} & {{ e.crew.username }}{% endif %}
            </div>

            <div class="d-flex gap-2 align-items-center">
                <span class="text-muted">⇅</span>

                <button type="button" class="btn btn-sm btn-outline-warning mark-dnf">
                    DNF
                </button>

                <button type="button" class="btn btn-sm btn-outline-danger mark-dsq">
                    DSQ
                </button>
            </div>

        </li>
        {% endfor %}
    </ul>

    {% if race.status != race.RaceStatus.FINISHED %}
        <button class="btn btn-success">Save Results</button>
    {% else %}
        <a href="{% url 'race-results-edit' race.pk %}" class="btn btn-warning">
            Edit Results
        </a>
    {% endif %}

</form>

</div>

{% endblock %}


{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const wrapper = document.querySelector("[data-editing]");
    const editing = wrapper?.dataset.editing === "1";

    const list = document.getElementById("finish-order");
    const form = document.getElementById("results-form");

    if (!list || !form) {
        console.log("Missing list or form");
        return;
    }

    // Holds DNF / DSQ selections
    const specialResults = {};

    // Rebuild state from DB colouring
    list.querySelectorAll("li").forEach(li => {
        const id = li.dataset.id;

        if (li.classList.contains("list-group-item-warning")) {
            specialResults[id] = "dnf";
        }
        if (li.classList.contains("list-group-item-danger")) {
            specialResults[id] = "dsq";
        }
    });

    // Renumber display
    function renumber() {
        list.querySelectorAll("li").forEach((li, index) => {
            const num = li.querySelector(".pos-number");
            if (num) num.textContent = (index + 1) + ".";
        });
    }

    // Enable drag only in edit mode
    if (editing) {
        Sortable.create(list, {
            animation: 150,
            onEnd: renumber,
        });
    }

    renumber();

    // Toggle DNF / DSQ
    if (editing) {

        list.querySelectorAll(".mark-dnf").forEach(btn => {
            btn.addEventListener("click", function () {
                const li = this.closest("li");
                const id = li.dataset.id;

                if (specialResults[id] === "dnf") {
                    delete specialResults[id];
                    li.classList.remove("list-group-item-warning", "list-group-item-danger");
                } else {
                    specialResults[id] = "dnf";
                    li.classList.remove("list-group-item-warning", "list-group-item-danger");
                    li.classList.add("list-group-item-warning");
                }
            });
        });

        list.querySelectorAll(".mark-dsq").forEach(btn => {
            btn.addEventListener("click", function () {
                const li = this.closest("li");
                const id = li.dataset.id;

                if (specialResults[id] === "dsq") {
                    delete specialResults[id];
                    li.classList.remove("list-group-item-warning", "list-group-item-danger");
                } else {
                    specialResults[id] = "dsq";
                    li.classList.remove("list-group-item-warning", "list-group-item-danger");
                    li.classList.add("list-group-item-danger");
                }
            });
        });
    }

    // Build POST payload
    form.addEventListener("submit", function () {

        let position = 1;

        list.querySelectorAll("li").forEach(li => {
            const id = li.dataset.id;

            if (specialResults[id]) {
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = `status_${id}`;
                input.value = specialResults[id];
                form.appendChild(input);
            } else {
                const posInput = document.createElement("input");
                posInput.type = "hidden";
                posInput.name = `position_${id}`;
                posInput.value = position++;
                form.appendChild(posInput);
            }
        });

    });

});
</script>
{% endblock %}
