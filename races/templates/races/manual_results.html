{% extends "base.html" %}
{% block content %}
<style>
.tied-row {
    background-color: #fff3cd;
}

</style>

<h3>Manual Positions – {{ race }}</h3>

<form method="post" id="manual-form">
{% csrf_token %}

<table class="table table-sm">
<thead>
<tr>
    <th></th>
    <th>Boat</th>
    <th>Helm</th>
    <th>Tie With Above</th>
</tr>
</thead>

<tbody id="sortable-body">
{% for row in entries %}
<tr data-id="{{ row.id }}"
    class="{% if row.tied %}tied-row{% endif %}">
    <td style="cursor:grab;">☰</td>
    <td>{{ row.race_entry.boat }}</td>
    <td>{{ row.race_entry.helm.username }}</td>
    <td>
        <input type="checkbox"
            class="tie-checkbox"
            {% if forloop.first %}disabled{% endif %}
            {% if row.tied %}checked{% endif %}>
    </td>
</tr>
{% endfor %}
</tbody>
</table>

{% if preview %}
    <hr>

    <h4 class="mt-4">Preview Final Positions</h4>

    <table class="table table-bordered table-sm">
        <thead class="table-light">
            <tr>
                <th>Pos</th>
                
                <th>Boat</th>
                <th>Helm</th>
                <th>Points</th>
            </tr>
        </thead>
        <tbody>
            {% for p in preview %}
            <tr>
                <td>
                    <strong>{{ p.position }}</strong>
                </td>
                
                <td>{{ p.row.race_entry.boat }}</td>
                <td>{{ p.row.race_entry.helm.username }}</td>
                <td><strong>{{ p.points }}</strong></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endif %}


<button name="action" value="save" class="btn btn-secondary">
    Save
</button>

<button name="action" value="preview" class="btn btn-primary">
    Preview
</button>

</form>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {

    const form = document.getElementById("manual-form");
    const sortableBody = document.getElementById("sortable-body");

    if (!sortableBody) return;  // safety guard

    Sortable.create(sortableBody, {
        animation: 150,
        onEnd: updateTieState
    });

    function updateTieState() {
        const rows = sortableBody.querySelectorAll("tr");

        rows.forEach((row, index) => {
            const checkbox = row.querySelector(".tie-checkbox");

            if (index === 0) {
                checkbox.checked = false;
                checkbox.disabled = true;
                row.classList.remove("tied-row");
            } else {
                checkbox.disabled = false;
                if (checkbox.checked) {
                    row.classList.add("tied-row");
                } else {
                    row.classList.remove("tied-row");
                }
            }
        });
    }

    document.querySelectorAll(".tie-checkbox").forEach(cb => {
        cb.addEventListener("change", updateTieState);
    });

    updateTieState();

    form.addEventListener("submit", function(){

        document.querySelectorAll(".generated-input").forEach(el => el.remove());

        const rows = sortableBody.querySelectorAll("tr");

        rows.forEach((row, index) => {

            const id = row.dataset.id;
            const tie = row.querySelector(".tie-checkbox").checked;

            // Position
            const posInput = document.createElement("input");
            posInput.type = "hidden";
            posInput.name = "pos_" + id;
            posInput.value = index + 1;
            posInput.classList.add("generated-input");
            form.appendChild(posInput);

            // Tie
            if (tie) {
                const tieInput = document.createElement("input");
                tieInput.type = "hidden";
                tieInput.name = "tie_" + id;
                tieInput.value = "on";
                tieInput.classList.add("generated-input");
                form.appendChild(tieInput);
            }
        });

    });

});

</script>

{% endblock %}
